import sys
sys.path.insert(0, '/home/lina/Desktop/Stage/Experiences/code')
from utils import *

parser = argparse.ArgumentParser(description='Analyses the dataframe \
generated by nbest_hypotheses_dataframe.py')
parser.add_argument('path', help='path to the dataframe in csv format')
args = parser.parse_args()

with Halo(text="Loading dataframe", spinner="dots") as spinner:
    df = pd.read_csv(args.path)
spinner.succeed()

with Halo(text="Doing stats on the dataframe", spinner="dots") as spinner:
    replacements = pd.Series([edition for liste in df["replace"].dropna().apply(eval) for edition in liste])
    inserts_dels = pd.Series([edition for liste in df["insert"].dropna().apply(eval) for edition in liste]
                    + [edition for liste in df["delete"].dropna().apply(eval) for edition in liste])

    pos_replacements = pd.Series([edition for liste in df["replace_pos"].dropna().apply(eval) for edition in liste])
    pos_inserts_dels = pd.Series([edition for liste in df["insert_pos"].dropna().apply(eval) for edition in liste]
                    + [edition for liste in df["delete_pos"].dropna().apply(eval) for edition in liste])

    replacements_nb = replacements.count()
    inserts_dels_nb = inserts_dels.count()
    hesitations_nb = replacements_nb + inserts_dels_nb
spinner.succeed()

print(f"\nNumber of hesitations between two possible formulations: {replacements_nb}"
      f" ({replacements_nb * 100 / hesitations_nb :.2f}% of hesitations)")
print(f"Of these, \n"
    f"- {pd.Series((len(r[0].split())==1) ^ (len(r[1].split())==1) for r in replacements).sum() * 100 / replacements_nb :.2f}"
    f"% are hesitations between one word and a multiword expression \n"
    f"- {pd.Series((len(r[0].split())==1) and (len(r[1].split())==1) for r in replacements).sum() * 100 / replacements_nb :.2f}"
    f"% are hesitations between two single words \n"
    f"- {pd.Series((len(r[0].split())>1) and (len(r[1].split())>1) for r in replacements).sum() * 100 / replacements_nb :.2f}"
    f"% are hesitations between two multiword expressions")

print(f"\nNumber of hesitations between including a word or expression or not: "
    f"{inserts_dels_nb} ({inserts_dels_nb * 100 / hesitations_nb :.2f}% of hesitations)")
print(f"Of these, \n"
    f"- {pd.Series((len(h.split())==1) for h in inserts_dels).sum() * 100 / inserts_dels_nb :.2f}"
    f"% are for single words \n"
    f"- {pd.Series((len(h.split())>1) for h in inserts_dels).sum() * 100 / inserts_dels_nb :.2f}"
    f"% are for multiword expressions")

print("\nThe most frequent hesitations between two possible formulations, followed by the number of times they occur, are:")
print(replacements.value_counts().head())
print("\nThe most frequent POS for such hesitations, followed by the number of times they occur, are:")
print(pos_replacements.value_counts().head())

print("\nThe most frequent hesitations between including a word or not, followed by the number of times they occur, are:")
print(inserts_dels.value_counts().head())
print("\nThe most frequent POS for such hesitations, followed by the number of times they occur, are:")
print(pos_inserts_dels.value_counts().head())
